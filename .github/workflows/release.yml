name: release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v6
        with:
          python-version: '3.10'
      - name: Install dependencies for development
        run: pip install twine kac-tools
      - name: Build package
        run: |
          mkdir -p public
          kac-tools >> public/RELEASENOTES.md
          python -m pip wheel --no-deps .
          twine check *.whl
          twine upload *.whl
        env:
          TWINE_USERNAME: ${{ vars.TWINE_USERNAME }}
          TWINE_REPOSITORY_URL: ${{ vars.TWINE_REPOSITORY_URL }}
          TWINE_PASSWORD: ${{ secrets.TWINE_PASSWORD }}
      - name: Archive release notes
        uses: actions/upload-artifact@v5
        with:
          name: release-notes
          path: public/RELEASENOTES.md
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: public/RELEASENOTES.md

  depoly-pages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
      - name: Install dependencies for development
        run: uv sync --all-extras
      - name: Build documentation
        run: |
            mkdir -p public
            uv run sphinx-apidoc -f -o doc/source src
            make -C doc html || exit_code=$?
            if [[ $exit_code -ne 0 ]]; then
              echo "Sphinx-build failure"
              exit 1
            else
              echo "Sphinx-build success"
              mv doc/build/html/* public
            fi
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          publish_branch: gh-pages
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public/
          force_orphan: true